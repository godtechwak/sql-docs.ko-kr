---
title: SQL Server 백업 애플리케이션 - VSS(볼륨 섀도 복사본 서비스) 및 SQL 기록기
description: SQL 기록기 구성 요소 및 SQL Server 데이터베이스의 VSS 스냅샷 만들기 및 복원 프로세스에서 해당 역할에 대해 설명합니다.
ms.custom: ''
ms.date: 07/24/2019
ms.prod: sql
ms.prod_service: backup-restore
ms.reviewer: ''
ms.technology: backup-restore
ms.topic: conceptual
author: cawrites
ms.author: chadam
ms.openlocfilehash: 3f098dc361d4e30a82dee198bb8203d19b412613
ms.sourcegitcommit: 5a1ed81749800c33059dac91b0e18bd8bb3081b1
ms.translationtype: HT
ms.contentlocale: ko-KR
ms.lasthandoff: 11/23/2020
ms.locfileid: "96125438"
---
# <a name="sql-server-back-up-applications---volume-shadow-copy-service-vss-and-sql-writer"></a>SQL Server 백업 애플리케이션 - VSS(볼륨 섀도 복사본 서비스) 및 SQL 기록기
 [!INCLUDE [SQL Server](../../includes/applies-to-version/sqlserver.md)]

SQL Server는 타사 백업 애플리케이션이 VSS 프레임워크를 사용하여 데이터베이스 파일을 백업할 수 있도록 기록기(SQL 기록기)를 제공하여 VSS(볼륨 섀도 복사본 서비스)를 지원합니다. 이 문서에서는 SQL 기록기 구성 요소 및 SQL Server 데이터베이스의 VSS 스냅샷 만들기 및 복원 프로세스에서 해당 역할에 대해 설명합니다. 또한 VSS 프레임워크에서 백업 애플리케이션과 함께 작동하도록 SQL 기록기를 구성하고 사용하는 방법에 대한 세부 정보도 캡처합니다.


## <a name="introduction"></a>소개

SQL Server는 VSS(볼륨 섀도 복사본 서비스)를 사용하여 SQL Server 데이터에서 스냅샷을 만들 수 있도록 지원합니다. 이 지원을 위해 타사 백업 애플리케이션이 VSS 프레임워크를 사용하여 데이터베이스 파일을 백업할 수 있도록 VSS 규격 기록기(SQL 기록기)를 제공합니다. 이 문서에서는 SQL 기록기 구성 요소 및 SQL Server 데이터베이스의 VSS 스냅샷 만들기 및 복원 프로세스에서 해당 역할에 대해 설명합니다. 또한 VSS 프레임워크의 컨텍스트에서 백업 애플리케이션과 함께 작동하도록 SQL 기록기를 구성하고 사용하는 방법에 대한 세부 정보도 캡처합니다.

## <a name="definition-of-terms"></a>용어 정의

- **가상 디바이스 인터페이스**: SQL Server는 백업 및 복원 작업을 지원하여 독립 소프트웨어 공급업체가 해당 제품에 SQL Server를 통합할 수 있도록 도와주는 VDI(가상 디바이스 인터페이스)라는 애플리케이션 프로그래밍 인터페이스를 제공합니다. 이 API는 최고의 안정성과 성능을 제공하도록 설계되었으며, 모든 최신 기능과 스냅샷 백업 기능을 포함하여 모든 SQL Server 백업 및 복원 기능을 지원합니다. 자세한 내용은 [SQL Server 2005 가상 백업 디바이스 인터페이스 사양](https://www.microsoft.com/download/details.aspx?id=17282)을 참조하세요. 

- **요청자**: 하나 이상 원본 볼륨의 스냅샷 세트를 하나 이상 만들도록 요청하는 프로세스(자동화 또는 GUI)입니다. 이 문서에서 요청자는 SQL Server 데이터베이스의 스냅샷을 만드는 백업 애플리케이션을 의미하기도 합니다.

## <a name="about-vss"></a>VSS 정보

VSS는 Windows 시스템에서 VSS 애플리케이션을 실행하기 위한 시스템 인프라를 제공합니다. 사용자와 개발자 모두에게 거의 드러나지 않지만 VSS는 다음 작업을 수행합니다.

- 섀도 복사본을 만들고 사용하는 과정에서 공급자, 기록기 및 요청자의 작업을 조정합니다.
- 기본 시스템 공급자를 제공합니다.
- 공급자가 작동하는 데 필요한 하위 수준 드라이버 기능을 구현합니다.

VSS 서비스는 요청 시 시작되므로, VSS 작업이 성공하려면 이 서비스를 사용하도록 설정해야 합니다.

## <a name="vss-components"></a>VSS 구성 요소

VSS는 다음과 같은 협동 구성 요소의 작업을 조정합니다. 

- 공급자는 섀도 복사본 데이터를 소유하고 섀도 복사본을 인스턴스화합니다.
- 기록기는 데이터를 변경하고 섀도 복사본 동기화 프로세스에 참여하는 애플리케이션입니다.
- 요청자는 섀도 복사본 생성 및 소멸을 시작합니다. 여기서는 요청자가 백업 애플리케이션인 시나리오에 중점을 두었습니다.

VSS는 이러한 구성 요소 간의 작업을 조정합니다. 

![VSS가 이러한 구성 요소 간의 작업을 조정하는 방법을 보여 주는 다이어그램](media/sql-server-vss-writer-backup-guide/coordinations.png)

이 다이어그램은 일반적인 VSS 스냅샷 작업에 참여하는 모든 구성 요소를 보여 줍니다. 해당 시나리오에서 SQL Server(SQL 기록기 포함)는 기록기 상자 중 하나에 있는 기록기 역할을 수행합니다.  다른 기록기로는 Exchange Server 등이 있을 수 있습니다.

이 문서의 나머지 부분에서는 독자가 VSS 프레임워크의 용어를 잘 알고 있다고 가정합니다.  자세한 내용은 [볼륨 섀도 복사본 서비스](/windows/win32/vss/volume-shadow-copy-service-overview) 문서를 참조하세요.

## <a name="about-sql-writer"></a>SQL 기록기 정보

SQL 기록기는 SQL Server에서 제공하는 VSS 기록기입니다. SQL Server와 VSS의 상호 작용을 처리합니다. SQL 기록기는 독립 실행형 서비스로 SQL Server와 함께 제공되며, SQL Server 설치의 일부로 설치됩니다. 기본적으로 SQL 기록기는 사용되지 않습니다. 서버 머신에서 실행하려면 명시적으로 사용하도록 설정해야 합니다.

VSS 스냅샷 백업 작업에서 SQL 기록기의 역할: 

![VSS 스냅샷](media/sql-server-vss-writer-backup-guide/sql-vss-snapshot.png)



## <a name="configuring-the-sql-writer"></a>SQL 기록기 구성

SQL 기록기 서비스는 SQL Server 설치의 일부로 시스템에 설치되며, Windows를 시작할 때 자동으로 시작되도록 구성됩니다. 

### <a name="sql-writer-service-account"></a>SQL 기록기 서비스 계정

설치 중에 로컬 시스템 계정을 사용하는 SQL 기록기 계정이 설치됩니다. SQL 기록기는 전용 VDI API를 통해 SQL Server와 통신해야 하므로, SQL 기록기 계정에 SQL Server와 VSS 둘 다에 대한 충분한 액세스 권한이 있어야 합니다.  서비스를 로컬 시스템 계정으로 구성하면 서비스가 올바르게 실행될 수 있는 충분한 권한이 제공됩니다.

  > [!NOTE]
  > SQL 기록기 서비스가 올바르게 작동하려면 SQL Server 인스턴스의 ‘sa’ 역할에서 로컬 시스템 계정이 제거되지 않도록 해야 합니다.

### <a name="enabling-and-starting-sql-writer"></a>SQL 기록기 사용 및 시작

SQL 기록기를 시작하고 사용하려면 다음을 수행해야 합니다.

SQL 기록기 서비스를 “자동”으로 표시하여 이 서비스를 사용하도록 설정할 수 있습니다. 제어판을 통해 서비스를 열려면 시작, 제어판을 차례로 클릭하고 관리 도구, 서비스를 차례로 두 번 클릭합니다. 서비스 창에서 SQL 기록기 서비스를 두 번 클릭하고 “시작 유형” 속성을 “자동”으로 수정합니다.

또한 위에서 언급한 서비스 속성 화면의 “서비스 상태” 속성 아래에서 “시작” 단추를 선택하여 서비스를 시작해야 합니다.

편의를 위해 SQL 기록기 서비스는 처음 시작될 때 이러한 변경 작업을 자동으로 수행합니다.

  > [!NOTE]
  > SQL Server Express 인스턴스가 설치되어 있고 애플리케이션이 사용자 인스턴스 기능을 사용하는 특정 경우에는 SQL Server에서 SQL 기록기를 자동으로 시작할 수도 있습니다. 이렇게 하면 VSS 백업 작업 중에 해당 사용자 인스턴스를 쉽게 열거할 수 있습니다. 

## <a name="backuprestore-operations-and-supported-versions"></a>백업/복원 작업 및 지원되는 버전

### <a name="version-support"></a>버전 지원

SQL 기록기는 SQL Server의 일부로 제공되며, SQL Server 인스턴스만 지원합니다. 

또한 SQL 기록기는 SQL Server Express 인스턴스를 열거합니다. SQL Server Express에서 시작된 사용자 인스턴스도 SQL 기록기를 통해 열거됩니다.


## <a name="supported-backuprestore-operations"></a>지원되는 백업/복원 작업

SQL Server(SQL 기록기 사용)는 다음과 같은 VSS 기반 백업 작업 모드를 지원합니다.

- 비구성 요소 기반
- 구성 요소 기반

### <a name="noncomponent-based-backup-operations"></a>비구성 요소 기반 백업 작업

비구성 요소 기반 백업은 스냅샷 세트에 있는 볼륨 목록을 사용하여 데이터베이스를 암시적으로 선택합니다. SQL 기록기는 조각난 데이터베이스가 있는지 검사하고, 있으면 오류가 발생합니다. 조각난 데이터베이스는 볼륨 목록을 통해 파일 하위 집합이 선택된 데이터베이스입니다.

비구성 요소 기반 모델에서는 단순 복구 모델을 사용하는 데이터베이스만 지원됩니다. 복원 후 롤포워드는 지원되지 않습니다.

### <a name="component-based-backup-operations"></a>구성 요소 기반 백업 작업

애플리케이션(VSS 백업 애플리케이션)은 SQL 기록기에서 반환된 메타데이터를 통해 데이터베이스를 명시적으로 선택하기 때문에 SQL 기록기와 함께 구성 요소 기반 백업을 사용하는 것이 좋습니다. 스냅샷 세트에는 해당 데이터베이스를 백업하는 데 필요한 모든 볼륨이 포함되어야 합니다. VSS 인프라는 선택한 데이터베이스 세트에 필요한 볼륨을 자동으로 추가하지 않습니다. 모든 백업 볼륨이 볼륨 스냅샷 세트에 포함되어야 합니다. 백업 애플리케이션은 모든 백업 볼륨이 스냅샷 세트에 포함되었는지 확인할 책임이 있습니다.  SQL 기록기가 조각난 데이터베이스(스냅샷 세트 외부에 백업 볼륨이 있음)를 검색하면 백업이 실패합니다.

이 문서의 나머지 부분에서는 SQL Server의 VSS 스냅샷 생성 프로세스에서 구성 요소 기반 백업을 사용한다고 가정합니다.

## <a name="features-supported-by-sql-writer"></a>SQL 기록기에서 지원하는 기능


- **전체 텍스트**: SQL 기록기는 하위 항목 포함 파일 사양이 있는 전체 텍스트 카탈로그 컨테이너를 기록기 메타데이터 문서의 데이터베이스 구성 요소 아래에 보고합니다.  데이터베이스 구성 요소를 선택하면 백업에 자동으로 포함됩니다.
- **차등 백업/복원**: SQL 기록기는 마지막 수정 시간 기준 차별화된 파일 및 부분 파일이라는 두 가지 VSS 차등 메커니즘을 통해 차등 백업/복원을 지원합니다.
- **부분 파일**:   SQL 기록기는 VSS 부분 파일 메커니즘을 사용하여 데이터베이스 파일 내에서 변경된 바이트 범위를 보고합니다.  
- **마지막 수정 시간 기준 차별화된 파일**: SQL 기록기는 VSS 마지막 수정 시간 기준 차별화된 파일 메커니즘을 사용하여 전체 텍스트 카탈로그에서 변경된 파일을 보고합니다.
- **복원(이동)** : SQL 기록기는 복원 중에 VSS 새 대상 지정을 지원합니다.  VSS 새 대상 지정을 사용하면 복원 작업의 일부로 데이터베이스/로그 파일 또는 전체 텍스트 카탈로그 컨테이너를 재배치할 수 있습니다.
- **데이터베이스 이름 바꾸기**: 특히 SQL 데이터베이스를 원본 데이터베이스와 나란히 복원해야 하는 경우 요청자가 SQL 데이터베이스를 새 이름으로 복원해야 할 수 있습니다. SQL 기록기는 데이터베이스가 원래 SQL 인스턴스 내에 유지되기만 하면 복원 작업 중에 데이터베이스 이름을 바꿀 수 있도록 지원합니다.
- **복사 전용 백업**: 예를 들어 테스트 목적으로 데이터베이스 복사본을 만들어야 하는 경우처럼 특별한 목적으로 사용할 백업을 만들어야 하는 경우가 있습니다.  이 백업은 데이터베이스의 전체 백업 및 복원 절차에 영향을 주지 않아야 합니다. COPY_ONLY 옵션을 사용하면 백업이 “대역 외” 상태로 수행되고 정상적인 백업 시퀀스에 영향을 주지 않도록 지정됩니다. SQL 기록기는 SQL Server 인스턴스에서 “복사 전용” 백업 유형을 지원합니다.
- **데이터베이스 스냅샷 자동 복구**:   일반적으로 VSS 프레임워크를 사용하여 만든 SQL Server 데이터베이스 스냅샷은 복구되지 않은 상태입니다. 복구 단계를 수행하여 진행 중인 트랜잭션을 롤백하고 데이터베이스를 일관된 상태로 유지하기 전에는 스냅샷의 데이터에 안전하게 액세스할 수 없습니다. VSS 백업 애플리케이션은 스냅샷 생성 프로세스에서 스냅샷 자동 복구를 요청할 수 있습니다.

이러한 새 기능과 해당 사용법은 이 문서의 백업 및 복원 옵션 세부 정보에 자세히 설명되어 있습니다.

### <a name="what-is-not-supported"></a>지원되지 않는 사항

- 로그 백업은 SQL 기록기에서 지원되지 않습니다.
- 파일/파일 그룹 백업은 지원되지 않습니다.
- 페이지 복원은 지원되지 않습니다.
- 데이터베이스 스냅샷은 지원되지 않으며, 구성 요소 및 비구성 요소 VSS 스냅샷을 만드는 동안 무시됩니다. 
- 데이터베이스 또는 종료가 사용 설정된 데이터베이스를 자동으로 닫습니다.
- Linux는 VSS 프레임워크를 제공하지 않으므로 Linux에서 SQL 기록기를 사용할 수 없습니다.

다음 표에는 모든 버전의 SQL Server용 VSS 프레임워크를 사용하는 SQL 기록기/SQL Server에서 지원하는 스냅샷 백업 종류가 나와 있습니다.

| **백업/복원 작업**                 | **구성 요소 기반**           | **비구성 요소 기반** |
|:-------------------------------------------- | :---------------------------- | :--------------------- |
|전체 데이터 백업 </br> (전체 텍스트 카탈로그 포함)| 예                     | 예                    |
|전체 복원                                  | 예                           | 예                    |
|전체 복원(복구 안 함)                    | 예                           | 예                     |
|차등 백업                           | 예                           | 예                     |
|차등 복원                          | 예                           | 예                     |
|복원(이동)                             | 예                           | 예                     |
|데이터베이스 이름 바꾸기                               | 예                           | 예                     |
|복사 전용 백업                              | 예                           | 예                     |
|자동 저장된 스냅샷                       | 예                           | 예                     |
|로그 백업                                    | 예                            | 예                     |
|데이터베이스 스냅샷                            | 예                            | 예                     |
|데이터베이스 자동 닫기</br> 종료가 사용 설정된 데이터베이스 | 예                        | 예                     |
|가용성 그룹 데이터베이스                  | 예                           | 보조 데이터베이스의 경우 아니요        | 




## <a name="snapshot-creation-process"></a>스냅샷 생성 프로세스

VSS 프레임워크는 SQL Server 스냅샷을 만드는 동안 요청자(백업 애플리케이션)와 SQL 기록기의 작업을 조정합니다. 이러한 조정을 사용하도록 설정하기 위해 VSS 프레임워크는 요청자 및 기록기 인터페이스를 정의합니다.  요청자 애플리케이션과 기록기를 연결하여 해당 인터페이스를 구현해야 합니다. SQL 기록기는 필요한 기록기 인터페이스를 구현합니다. 스냅샷 생성 프로세스에서 VSS 프레임워크가 SQL 기록기의 인터페이스를 호출합니다. SQL 기록기는 스냅샷을 만들기 쉽도록 시스템의 SQL Server 인스턴스와 상호 작용합니다.

VSS 프레임워크는 요청자/백업 애플리케이션에서 사용할 API 세트를 정의합니다. 백업 애플리케이션 개발자는 이러한 API 호출 패턴에 따라 VSS 프레임워크 스냅샷 생성 프로세스를 사용해야 합니다. 다음 섹션에서는 SQL 기록기 관점에서 스냅샷 생성 프로세스를 설명합니다. 또한 요청자, VSS 프레임워크, SQL 기록기 및 SQL Server 인스턴스 간의 몇 가지 내부 상호 작용에 대해 자세히 설명합니다. 이러한 단계와 VSS 프레임워크 인터페이스에 대한 자세한 내용은 볼륨 섀도 복사본 서비스 문서를 참조하세요.    

  > [!NOTE]
  > 독자가 VSS 프레임워크와 백업 생성 프로세스의 일반적인 내용을 잘 알고 있다고 가정합니다. 이 섹션은 SQL 기록기가 VSS 백업 생성 프로세스에 참여하는 방식에 대한 추가 정보로 제공됩니다.

## <a name="snapshot-creation-workflow"></a>스냅샷 생성 워크플로

![데이터 흐름](media/sql-server-vss-writer-backup-guide/dataflow-chart.png)

위 이미지는 구성 요소 기반 스냅샷 생성/백업 작업 중의 데이터 흐름 다이어그램을 보여 줍니다. 이 개요를 다음 단계로 세분화하면 백업을 수행하는 데 필요한 기본 작업을 완전히 파악하는 데 유용합니다.

- 백업 초기화
- 백업 검색 단계
- 백업 전 작업
- 실제 파일 백업
- 백업 종료



### <a name="backup-initialization"></a>백업 초기화

이 백업 단계에서는 요청자(백업 애플리케이션)가 스냅샷 인터페이스 **IvssBackupComponents** 에 바인딩하고 백업 준비를 위해 초기화합니다. 또한 VSS API **IVssGatherWriterMetadata** 를 호출하여 VSS 프레임워크에 모든 기록기의 메타데이터를 수집하도록 지시합니다.

VSS 프레임워크는 기록기 메타데이터를 위해 **OnIdentify** 이벤트를 사용하여 SQL 기록기를 비롯한 등록된 각 기록기를 호출합니다. SQL 기록기는 SQL Server 인스턴스를 쿼리하여 각 데이터베이스에 대한 백업 메타데이터 정보를 가져오고 기록기 메타데이터 문서를 만듭니다. 이 단계를 메타데이터 열거라고도 합니다.

기록기 메타데이터 문서는 기록기에서 요청자(백업 애플리케이션)로 전달된 정보를 포함하는 문서입니다. 기록기 메타데이터 문서에는 다음 정보가 포함되어 있습니다.

- 애플리케이션 ID 및 식별 이름
- 파일 및 구성 요소가 있는 위치
- 백업에 포함하거나 제외해야 하는 파일
- 복원 시 사용해야 하는 옵션
- 이 정보는 VSS 프레임워크를 통해 요청자에게 다시 전달됩니다.

### <a name="sql-writer-metadata-document"></a>SQL 기록기 메타데이터 문서

기록기(이 경우 SQL 기록기)가 **IVssCreateWriterMetadata** 인터페이스를 사용하고 기록기의 상태 및 구성 요소에 대한 정보를 포함하여 만든 XML 문서입니다. 기록기 메타데이터 문서의 구조 세부 정보는 VSS API 문서에 설명되어 있습니다. 다음은 SQL 기록기 메타데이터 문서의 몇 가지 세부 정보입니다.

- 기록기 식별 정보
    - **기록기 이름** - L“SqlServerWriter”
    - **기록기 클래스 ID** -  0xa65faa63, 0x5ea8, 0x4ebc, 0x9d, 0xbd, 0xa0, 0xc4, 0xdb, 0x26, 0x91, 0x2a 
    - **기록기 인스턴스 ID** - L“SQL Server:SQLWriter” 
    - **VSSUsageType** - VSS_UT_USERDATA 
    - **VSSSourceType** - VSS_ST_TRANSACTEDDB 
- 기록기 수준 정보 - VSS_APP_BACK_END 
- 복원 방법 지정 – VSS_RME_RESTORE_IF_CAN_REPLACE.
- 지원되는 백업 스키마(IVssCreateWriterMetadata::SetBackupSchema API)
    - VSS_BS_DIFFERENTIAL – 차등 백업
    - VSS_BS_TIMESTAMPED – 타임스탬프 기반 – 전체 텍스트 카탈로그 파일에 사용
    - VSS_BS_LAST_MODIFY – 마지막 수정 시간 기준 차등 백업
    - VSS_BS_WRITER_SUPPORTS_NEW_TARGET – 새 대상 위치 옵션 지원
    - VSS_BS_WRITER_SUPPORTS_RESTORE_WITH_MOVE – 복원(이동) 지원
    - VSS_BS_COPY – “복사 전용” 백업 옵션 지원
- 구성 요소 수준 정보. SQL 기록기에서 제공하는 구성 요소 수준의 특정 정보를 포함합니다.
   - **유형** - VSS_CT_FILEGROUP
   - **이름** - 구성 요소 이름(데이터베이스 이름)
   - **논리 경로** – 서버 인스턴스의 논리 경로(명명된 인스턴스의 경우 “server\instance-name” 형식, 기본 인스턴스의 경우 “server” 형식)
   - **구성 요소 플래그**
   - **VSS_CF_APP_ROLLBACK_RECOVERY** – 파일을 일관성 있고 백업 이외의(즉, 앱 롤백) 시나리오에 사용할 수 있도록 유지하기 위해 SQL Server 스냅샷에 항상 “복구” 단계가 필요함을 나타냅니다.
   - Selectable - True
   - Selectable for Restore - True 
   - 지원되는 복원 방법 - VSS_RME_RESTORE_IF_CAN_REPLACE

SQL Server의 구성 요소 세트 구조 확장은 전체 텍스트 카탈로그 도입뿐입니다.  전체 텍스트 카탈로그는 VSS 데이터베이스와 로그 파일에 하위 항목 포함 지정이 없을 경우 VSS 데이터베이스 또는 로그 파일로 표현할 수 없는 컨테이너 디렉터리입니다.  따라서 SQL 기록기는 VSS 파일 그룹 구성 요소(VSS_CT_FILEGROUP)를 사용하여 데이터베이스 수준 구성 요소를 나타내고, 파일 그룹 파일을 사용하여 데이터베이스, 로그 및 전체 텍스트 카탈로그 파일을 나타냅니다.

이 문서의 끝에 기록기 메타데이터 문서 예가 제공됩니다.

### <a name="backup-discovery"></a>백업 검색
이 단계에서 요청자는 기록기 메타데이터 문서를 검사하고 백업해야 하는 각 구성 요소로 **백업 구성 요소 문서** 를 만들고 채웁니다. 필요한 백업 옵션과 매개 변수도 이 문서에서 지정합니다. SQL 기록기의 경우 백업해야 하는 각 데이터베이스 인스턴스는 개별 구성 요소입니다.

#### <a name="backup-components-document"></a>백업 구성 요소 문서
복원 또는 백업 작업을 설정하는 과정에서 요청자가 **IVssBackupComponents** 인터페이스를 사용하여 만든 XML 문서입니다. 백업 구성 요소 문서에는 백업 또는 복원 작업에 참여하는 하나 이상의 기록기에서 명시적으로 포함된 구성 요소 목록이 포함됩니다. 암시적으로 포함된 구성 요소 정보는 포함되지 않습니다. 반면, 기록기 메타데이터 문서에는 백업에 참여할 수 있는 기록기 구성 요소만 포함됩니다. 백업 구성 요소 문서의 구조 세부 정보는 VSS API 문서에 설명되어 있습니다.

#### <a name="prebackup-tasks"></a>백업 전 작업
VSS에서의 백업 전 작업은 백업 데이터를 포함하는 볼륨의 섀도 복사본을 만드는 데 중점을 둡니다. 백업 애플리케이션은 실제 볼륨이 아니라 섀도 복사본의 데이터를 저장합니다.

요청자는 일반적으로 기록기가 백업을 준비하고 섀도 복사본을 만드는 동안 대기합니다. SQL 기록기가 백업 작업에 참여하는 경우, 해당 파일을 구성하고 백업 및 섀도 복사본 준비를 완료해야 합니다.

#### <a name="prepare-for-backup"></a>백업 준비
요청자는 수행해야 하는 백업 작업 유형을 설정한 다음(**IVssBackupComponents::SetBackupState**), **IVssBackupComponents::PrepareForBackup** 을 사용하여 백업 작업을 준비하도록 VSS를 통해 기록기에 알려야 합니다.

SQL 기록기에는 백업해야 하는 데이터베이스를 자세히 설명하는 백업 구성 요소 문서에 대한 액세스 권한이 부여됩니다. 모든 백업 볼륨이 볼륨 스냅샷 세트에 포함되어야 합니다. SQL 기록기가 조각난 데이터베이스(스냅샷 세트 외부에 백업 볼륨이 있음)를 검색하면 PostSnapshot 이벤트 중에 백업이 실패합니다.

**스냅샷 시작** 요청자가 VSS 프레임워크 인터페이스 DoSnapshotSet를 호출하여 스냅샷 프로세스를 시작합니다.

**스냅샷 만들기** 이 단계에는 VSS 프레임워크와 SQL 기록기 간에 수행되는 일련의 상호 작용이 포함됩니다.

1. ‘스냅샷 준비’. SQL 기록기가 SQL Server를 호출하여 스냅샷을 만들 준비를 합니다.
1. ‘동결’. SQL 기록기가 SQL Server를 호출하여 스냅샷에 백업되는 각 데이터베이스에 대해 모든 데이터베이스 I/O를 동결합니다. 동결 이벤트가 VSS 프레임워크로 반환되면 VSS에서 스냅샷을 만듭니다.
1. ‘재개’. 이 이벤트에서는 SQL 기록기가 SQL Server 인스턴스를 호출하여 정상적인 I/O 작업을 “재개”하거나 계속합니다.


데이터베이스에 대한 모든 쓰기를 차단하지 않기 위해 스냅샷 생성 단계는 빠르게 수행됩니다(60초 미만).

**스냅샷 이후 작업** 스냅샷에 자동 복구가 필요한 경우에는 SQL 기록기가 스냅샷에 포함되도록 선택한 각 데이터베이스에 대해 자동 복구를 수행합니다. 자세한 설명은 자동 저장된 스냅샷을 참조하세요.

#### <a name="actual-backup-of-files"></a>실제 파일 백업

이 단계에서는 요청자가 필요한 경우 데이터를 백업 미디어로 이동할 수 있습니다. 이 단계의 상호 작용은 요청자와 VSS 프레임워크 간에 수행됩니다. SQL 기록기는 관련이 없습니다.

1. 기록기 상태를 가져옵니다. 기록기 상태를 반환합니다. 여기서 요청자가 오류를 처리해야 할 수도 있습니다.
1. 백업합니다.

필요한 경우 이 시점에 요청자가 데이터를 백업 미디어로 이동할 수 있습니다.

#### <a name="backup-complete"></a>백업 완료

이 이벤트는 백업이 성공적으로 완료되었음을 나타냅니다.

현재 백업이 복사 전용 백업이 아니라 데이터베이스 전체 백업인 경우, 이 시점에 SQL 기록기에서 백업을 차등 기반으로 커밋할 수도 있습니다.


  > [!NOTE]
  > 요청자가 이 이벤트(백업 완료 이벤트)를 명시적으로 전송하여 SQL 기록기에서 차등 기반 백업을 커밋할 수 있도록 해야 합니다. 이 이벤트가 수신되지 않으면 생성된 백업을 적격한 “차등 기반” 백업으로 사용할 수 없습니다.

#### <a name="save-writer-metadata"></a>기록기 메타데이터 저장

요청자는 스냅샷에서 백업된 데이터와 함께 백업 구성 요소 문서 및 각 구성 요소 백업 메타데이터를 저장해야 합니다. 이러한 기록기 메타데이터는 SQL 기록기/SQL Server에서 복원 작업을 수행하는 데 필요합니다.

#### <a name="backup-termination"></a>백업 종료

요청자가 **IVssBackupComponents** 인터페이스를 해제하거나 **IVssBackupComponents::DeleteSnapshots** 를 호출하여 섀도 복사본을 종료합니다.

## <a name="restore-process"></a>복원 프로세스

이 섹션에서는 복원 작업 워크플로 및 관련된 여러 단계에 대해 설명합니다.

### <a name="restore-operation-workflow"></a>복원 작업 워크플로

다음 그림은 VSS 복원 작업 중의 데이터 흐름 다이어그램을 보여 줍니다. 이 개요를 다음 항목으로 세분화하면 복원을 수행하는 데 필요한 기본 작업을 완전히 파악하는 데 유용합니다.

- 복원 초기화
- 복원 준비
- 실제 파일 복원
- 복원 정리 및 종료

![복원 프로세스 흐름](media/sql-server-vss-writer-backup-guide/restore-process-flow.png)

모든 VSS 구성 요소 기반 복원 시나리오에서 SQL 기록기는 다음 두 가지 개별 단계로 데이터베이스 복원을 처리합니다.

- **복원 전 작업**:  SQL 기록기가 유효성 검사, 파일 핸들 닫기 등을 처리합니다.
- **복원 후 작업**:  SQL 기록기가 데이터베이스를 연결하고, 필요한 경우 크래시 복구를 수행합니다.

이러한 두 단계 사이에 백업 애플리케이션이 SQL 아래에서 관련 데이터를 이동합니다.

### <a name="restore-initialization"></a>복원 초기화

복원의 초기화 단계에서는 요청자가 저장된 백업 구성 요소 문서에 액세스할 수 있어야 합니다.

백업 작업 중에 생성된 백업 구성 요소 문서는 백업 데이터의 일부로 저장됩니다. 백업 애플리케이션이 이 데이터를 VSS 프레임워크로 다시 전달해야 합니다. 복원 프로세스를 시작할 때 SQL 기록기에 이 데이터에 대한 액세스 권한이 부여됩니다.

#### <a name="prepare-for-restore"></a>복원 준비

복원을 준비할 때 요청자는 저장된 백업 구성 요소 문서를 사용하여 복원할 항목과 방법을 확인합니다.  요청자가 복원할 구성 요소를 선택하고 필요에 따라 적절한 복원 옵션을 설정합니다.

백업 애플리케이션을 통해 현재 복원 작업에 차등 또는 로그 백업을 적용하려는 경우(즉, “NORECOVERY를 사용하여 복원”이 필요한 경우), 복원되는 각 데이터베이스의 구성 요소를 만드는 과정에서 다음 옵션을 설정해야 합니다.

```
IVssBackupComponents::SetAdditionalRestores(true)
```

백업 구성 요소 문서에 필요한 모든 세부 정보가 설정되면 요청자가 **IVssBackupComponents::PreRestore** 를 호출하여 VSS를 통해 기록기에서 처리할 PreRestore 이벤트를 생성합니다.

SQL 기록기는 제공된 백업 구성 요소 문서를 검사하여 적절한 데이터베이스를 확인하고 백업 시간 이후에 만들어진 추가 파일을 모두 삭제합니다. 또한 디스크 공간을 확인하고 열려 있는 데이터베이스 파일 핸들을 모두 닫아 요청자가 복원 단계에서 필요한 데이터를 복사할 수 있도록 합니다. 이 단계에서는 요청자가 실제 파일 복사를 수행하기 전에 초기 오류 조건을 검색할 수 있습니다. 또한 SQL Server에서 데이터베이스를 복원 중 상태로 전환합니다.  이 시점부터 복원이 성공할 때까지 데이터베이스를 시작할 수 없습니다.

#### <a name="restore-files"></a>파일 복원

전적으로 요청자 관련 작업입니다. 요청자(백업 애플리케이션)는 필요한 데이터베이스 파일(또는 차등 복원의 경우 관련된 범위의 데이터)을 적절한 위치에 복사할 책임이 있습니다. SQL 기록기는 이 작업과 관련이 없습니다.

#### <a name="cleanup-and-termination"></a>정리 및 종료

모든 데이터가 올바른 위치에 복원되면, 복원 작업이 완료되었음을 알리는 요청자의 호출(**IvssBackupComponents::PostRestore**)을 통해 SQL 기록기가 복원 후 작업을 시작할 수 있음을 알게 됩니다.  이 시점에 SQL 기록기는 크래시 복구의 다시 실행 단계를 수행합니다. 복구가 요청되지 않은 경우(즉, 요청자가 SetAdditionalRestores(true)를 지정하지 않은 경우), 복구 단계의 실행 취소 단계도 이 단계에서 수행됩니다.

## <a name="backup-and-restore-option-details"></a>백업 및 복원 옵션 세부 정보

이 섹션에서는 SQL 기록기에서 지원하는 모든 백업 및 복원 옵션을 자세히 설명합니다.

### <a name="requestor-creates-a-volume-shadow-copy"></a>요청자가 볼륨 섀도 복사본 생성

db 파일의 백업 볼륨이 볼륨 스냅샷 세트에 추가되어 SQL 기록기가 백업/복원 컨텍스트 외부의 볼륨 섀도 복사본 생성 프로세스에 관련될 수 있습니다.  이 경우 SQL 기록기는 메타데이터 열거, 동결, 재개, PrepareForSnapshot 및 PostSnapshot 조정에만 참여합니다(자세한 내용은 데이터 흐름 다이어그램 참조).

### <a name="full-backuprestore"></a>전체 백업/복원

SQL 기록기는 비구성 요소 기반 모드와 구성 요소 기반 모드에서 전체 백업/복원 작업을 지원합니다.

### <a name="noncomponent-based-backup-and-restore"></a>비구성 요소 기반 백업 및 복원

비구성 요소 기반 백업/복원에서는 요청자가 백업/복원할 볼륨 또는 폴더 트리를 지정합니다. 지정한 볼륨/폴더에 있는 모든 데이터가 백업/복원됩니다.

#### <a name="backup"></a>Backup

비구성 요소 기반 백업에서는 SQL 기록기가 스냅샷 세트에 있는 볼륨 목록을 사용하여 데이터베이스를 암시적으로 선택합니다.  기록기는 조각난 데이터베이스가 있는지 검사하고, 있으면 오류가 발생합니다. 조각난 데이터베이스는 볼륨 목록을 통해 파일 하위 집합이 선택된 데이터베이스입니다.  복원 후의 롤포워드(차등 또는 로그 복원)는 SQL 기록기에서 지원되지 않습니다.

#### <a name="restore"></a>복원

요청자가 비구성 요소 기반 모드에서 백업된 데이터베이스를 복원합니다.  이러한 복원 후에는 로그 복원 또는 차등 복원과 같은 롤포워드 복원을 수행할 수 없습니다.

비구성 요소 기반 복원 작업의 경우, 오프라인에서 SQL Server 인스턴스를 사용하여 복원을 수행해야 합니다. 그러지 않으면 파일이 오프라인 상태가 되도록 대상 데이터베이스가 삭제/분리됩니다.  파일이 현재 위치에 복사되고 데이터베이스가 연결됩니다. 이러한 모든 작업은 SQL 기록기의 범위 밖에서 수행됩니다.

### <a name="component-based-backup-and-restore"></a>구성 요소 기반 백업 및 복원

구성 요소 기반 백업에서는 SQL 기록기가 클라이언트로 반환하는 메타데이터를 통해 요청자가 백업/복원할 데이터베이스 구성 요소를 명시적으로 선택합니다.

#### <a name="backup"></a>Backup

구성 요소 기반 백업에서는 선택한 데이터베이스의 모든 백업 볼륨이 볼륨 스냅샷 세트에 포함되어야 합니다.  포함되지 않으면 SQL 기록기가 조각난 데이터베이스(스냅샷 세트 외부에 백업 볼륨이 있음)를 검색하고 백업할 수 없게 됩니다.  전체 백업은 복원 시 데이터베이스를 트랜잭션 측면에서 일관된 상태로 만드는 필요한 모든 로그 파일과 데이터베이스 데이터를 백업합니다.

#### <a name="full-restore-without-rollforward"></a>전체 복원(롤포워드 제외)

추가 롤포워드 없이 데이터베이스 백업의 전체 복원을 수행하는 경우도 있습니다. 롤포워드를 가능하게 하는 메타데이터가 없거나, 경우에 따라 롤포워드가 필요 없기 때문일 수 있습니다. 이 섹션에서는 이러한 두 가지 상황을 간략하게 설명합니다.  

#### <a name="no-metadatano-rollforward"></a>메타데이터 없음/롤포워드 없음

백업 작업 중에 기록기 메타데이터(구성 요소 기반 백업 메타데이터)를 저장하지 않은 경우, 오프라인에서 SQL Server 인스턴스를 사용하여 복원을 수행해야 합니다. 그러지 않으면 파일이 오프라인 상태가 되도록 대상 데이터베이스가 삭제/분리됩니다.  파일이 현재 위치에 복사되고 데이터베이스가 연결됩니다. 이러한 모든 작업은 SQL 기록기의 범위 밖에서 수행됩니다.

#### <a name="metadata-exist-but-no-additional-rollforward-is-needed"></a>메타데이터가 있지만 추가 롤포워드가 필요 없음

요청자가 구성 요소 기반 모드에서 백업된 데이터베이스를 복원하지만 롤포워드를 요청하지 않았습니다. 이 경우 SQL Server는 복원 작업의 일부로 데이터베이스에서 크래시 복구를 수행합니다.

**전체 복원(추가 롤포워드 포함)** 요청자가 SetAdditionalRestores(true) 옵션을 지정하여 복원을 실행할 수 있습니다.  이 옵션은 요청자가 후속 작업으로 추가 롤포워드 복원(예: 로그 복원, 차등 복원 등)을 수행할 예정임을 나타냅니다. 이렇게 하면 SQL Server가 복원 작업을 종료할 때 복구 단계를 수행하지 않습니다.

백업 중에 기록기 메타데이터를 저장했으며 복원 시 SQL 기록기에서 사용할 수 있는 경우에만 이 옵션을 선택할 수 있습니다. 요청자가 VSS에 복원 작업을 수행하도록 지시하기 전에 SQL Server 서비스가 실행 중이어야 합니다.

SQL 기록기에 필요한 시퀀스는 다음과 같습니다.

1. 각 데이터베이스를 복원할 준비를 합니다. 이 작업 중에 모든 파일 핸들을 닫아 요청자 애플리케이션이 데이터베이스 파일을 복사/탑재할 수 있도록 해야 합니다.
1. 요청자 애플리케이션이 파일을 복사/탑재합니다.
1. 복원(NORECOVERY 사용)을 완료합니다.  데이터베이스가 온라인 상태로 전환되지만 “복원 중” 상태입니다.

그런 다음, 기존 SQL 백업(차등 또는 로그)을 사용하여 VDI/T-SQL을 통해 또는 VSS 프레임워크로 차등 복원을 적용해서 데이터베이스를 롤포워드할 수 있습니다.

### <a name="full-text-support"></a>전체 텍스트 지원

SQL 기록기는 하위 항목 포함 파일 사양이 있는 전체 텍스트 카탈로그 컨테이너를 기록기 메타데이터 문서의 데이터베이스 구성 요소 아래에 보고합니다.  데이터베이스 구성 요소를 선택하면 백업에 자동으로 포함됩니다.

### <a name="differential-backuprestore"></a>차등 백업/복원

차등 백업 작업은 최근의 기준 전체 백업 이후에 변경된 데이터만 백업합니다. 차등 백업에는 데이터베이스 파일의 변경된 부분만 포함됩니다. 이러한 백업을 수행하려면, 백업 애플리케이션 또는 요청자가 적절한 파일 섹션을 백업할 수 있도록 데이터베이스 파일에서 변경된 내용의 위치 정보가 필요합니다. 차등 백업 작업 중에 SQL 기록기는 “VSS 부분 파일 정보”에 지정된 형식으로 이 정보를 제공합니다. 이 정보를 사용하여 데이터베이스 파일에서 변경된 부분만 백업할 수 있습니다.

### <a name="backup"></a>Backup

요청자는 VSS를 사용하여 백업 작업을 시작할 때 백업 구성 요소 문서(**IVssBackupComponents::SetBackupState**)에서 DIFFERENTIAL 옵션(**VSS_BT_DIFFERENTIAL**)을 설정하여 차등 백업을 실행할 수 있습니다.  SQL 기록기는 SQL Server에서 반환된 부분 파일 정보를 VSS에 전달합니다.  요청자는 VSS API(**IVssComponent::GetPartialFile**)를 호출하여 이 파일 정보를 가져올 수 있습니다. 이 부분 파일 정보를 통해 요청자는 데이터베이스 파일에서 백업할, 변경된 바이트 범위만 선택할 수 있습니다.

백업 전 작업 단계에서 SQL 기록기는 선택한 데이터베이스마다 단일 차등 기반이 있는지 확인합니다.

PostSnapshot 이벤트 중에 SQL 기록기는 SQL Server에서 부분 파일 정보를 가져온 다음, **IVssComponent::AddPartialFile** 호출을 사용하여 백업 구성 요소 문서에 추가합니다.  

  > [!NOTE]
  > SQL 기록기는 차등 백업에 대해 단일 차등 기준만 지원합니다. 다중 기준은 지원되지 않습니다.

### <a name="partial-file-information-format"></a>부분 파일 정보 형식

차등 백업 중에 백업되는 각 데이터베이스에 대해 SQL 기록기는 각 데이터베이스 파일의 부분 파일 정보를 저장합니다. 이 정보는 요청자 또는 백업 애플리케이션에서 실제 파일 백업 중에 파일의 관련 부분만 백업 미디어에 복사하는 데 사용됩니다. 이 부분 파일 정보 형식에 대한 자세한 내용은 볼륨 섀도 복사본 서비스 문서를 참조하세요.

요청자는 **IVssComponent::GetPartialFileCount** 및 **IVssComponent::GetPartialFile** 을 호출하여 이러한 파일을 확인할 수 있습니다.  **IVssComponent::GetPartialFile** 은 파일을 가리키는 경로 및 파일 이름과 백업해야 하는 파일 부분을 나타내는 범위 문자열을 반환합니다.

부분 파일 정보 검색에 대한 자세한 내용은 [VSS 문서](/windows/win32/vss/volume-shadow-copy-service-overview)를 참조하세요.

### <a name="back-up-files"></a>파일 백업

이 단계에서는 백업 애플리케이션이 백업 구성 요소 문서에 저장된 기록기 메타데이터를 확인하고 파일의 관련 부분만 백업해야 합니다. 전체 텍스트 카탈로그 파일의 경우, 파일 타임스탬프를 기준으로 이 백업을 수행해야 합니다. 이 내용에 대해서는 이 문서의 뒷부분에서 설명합니다.

차등 백업은 항상 데이터베이스의 최신 기준 백업을 기준으로 합니다.  복원 시 SQL Server는 일치하지 않는 기준 백업과 차등 백업을 검색합니다. 따라서 백업 애플리케이션 또는 시스템 관리자는 차등이 예상 전체 백업을 기준으로 하는지 확인할 책임이 있습니다.  대역 외 절차에서 다른 전체 백업을 수행한 경우, 백업 애플리케이션이 기준 백업을 “소유”하고 있지 않으므로 차등을 복원하지 못할 수도 있습니다.

현재, 바이트 범위 정보(부분 파일 정보)가 너무 커서 버퍼 크기가 64K 바이트를 초과하는 경우 SQL Server에서 오류가 발생하고 사용자에게 전체 백업을 수행하도록 지시합니다.

### <a name="interesting-cases-during-backup"></a>백업 도중 흥미로운 사례

파일 추가/삭제/축소/확장/논리적 이름 바꾸기/물리적 이름 바꾸기는 백업에서 흥미로운 사례를 만듭니다.

**기반을 만든 후에 새로 추가된 파일**

SQL 데이터베이스 파일의 모든 헤더가 부분 지정에 포함되어야 하므로 이러한 파일도 부분 지정에 포함됩니다.  헤더 페이지 외에도 할당된 모든 페이지를 부분 지정에 포함해야 합니다.

**기반을 만든 후에 삭제된 파일**

기반을 만든 후에 데이터 파일을 삭제할 수 있습니다.  이러한 파일은 차등 백업 중에 기록기 메타데이터 문서에 포함되지 않습니다.  또한 삭제된 파일과 관련된 부분 정보는 없습니다.

**기반을 만든 후에 축소된 파일**

서버에서 파일 축소를 사용하지 않도록 설정할 때까지 파일에서 부분 정보가 수집되지 않습니다.  이렇게 하면 데이터 파일의 축소된 영역에 해당하는 부분 정보가 포함되지 않습니다.  

**기반을 만든 후에 확장된 파일**

부분 정보를 수집하기 전에 파일이 확장된 경우, 확장된 영역에 할당된 페이지가 부분 정보에 포함되어야 합니다.  부분 정보를 수집한 후에 파일이 확장된 경우에는 확장된 영역의 변경 내용이 부분 정보에 포함되지 않습니다.  다음 섹션에서 이러한 변경 내용이 로그 롤포워드를 통해 복원되는 것을 확인할 수 있습니다.

**기반을 만든 후에 논리적으로 이름이 바뀐 파일**

파일의 논리적 이름은 기록기 메타데이터 문서 또는 백업 구성 요소 문서에서 참조되지 않으므로 파일의 논리적 이름을 바꾸어도 백업 또는 복원에 영향을 주지 않습니다.  자세한 내용은 기록기 메타데이터 문서: 예제를 참조하세요.

**기반을 만든 후에 물리적으로 이름이 바뀐 파일**

데이터베이스 파일의 물리적 이름을 바꾼 경우 데이터베이스를 다시 시작해야 적용됩니다.  따라서 부분 정보 버퍼에 있는 데이터베이스 구성 정보 또는 파일 경로 정보는 여전히 이전 물리적 경로를 기반으로 합니다. 이 경로만 스냅샷에 있는 해당 데이터베이스 파일의 유효한 경로이기 때문입니다.

### <a name="restore"></a>복원

차등 복원 중에 요청자가 SQL 기록기로 다시 전달하는 백업 메타데이터에는 백업 유형 정보가 있습니다.  따라서 SQL 기록기에서는 특별한 처리가 필요하지 않습니다.  SQL Server가 자체적으로 차등 복원임을 파악합니다.  SQL Server는 VSS를 통해 수행되지 않은 네이티브 차등 복원과 동일한 방식으로 이러한 차등 복원을 처리합니다.

### <a name="prerestore-phase"></a>복원 전 단계

이 단계에서는 SQL Server가 차등 백업의 파일 메타데이터에 따라 모든 파일의 크기를 적절한 크기로 조정합니다.  파일이 확장된 경우 SQL Server는 확장된 부분을 0으로 지정합니다.  새 파일을 만들어야 하는 경우(기반을 만든 후에 파일이 생성된 경우) SQL Server는 새 파일을 0으로 지정합니다. 또한 백업 애플리케이션이 백업 미디어에서 복원된 데이터로 파일을 덮어쓸 수 있도록 모든 파일 핸들을 닫습니다.

### <a name="restore-files"></a>파일 복원

클라이언트가 부분 파일 사양에 따라 파일을 복원해야 합니다.  기록기 메타데이터에 저장된 부분 파일 사양에 지정된 대로 데이터베이스 파일의 동일한 오프셋/범위로 데이터를 복원해야 합니다.

데이터베이스 파일 추가/삭제/확장/축소/논리적 이름 바꾸기/물리적 이름 바꾸기는 복원 시에도 흥미로운 사례를 만듭니다.

**전체 기반을 만든 후에 데이터베이스 파일이 추가된 경우**

SQL Server가 복원 준비 단계에서 이러한 파일을 미리 만들어야 합니다.  올바른 크기로 확장하고 0으로 지정해야 합니다.  클라이언트는 부분 사양에 따라 데이터를 배치하기만 하면 됩니다(부분 사양에는 할당된 모든 익스텐트가 포함됨).

**전체 기반을 만든 후에 데이터베이스 파일이 삭제된 경우**

이러한 파일 삭제에 대한 추적 정보는 SQL Server에서 제공한 부분 정보에 포함되지 않습니다.  SQL Server는 기존 컨테이너와 복원된 파일 메타데이터를 비교하여 삭제할 파일을 검색하고 실제로 삭제할 책임이 있습니다.  이 작업은 복원 전에 준비 단계로 수행됩니다.

**전체 기반을 만든 이후 데이터베이스 파일이 확장된 경우**

SQL Server가 복원 준비 단계에서 이러한 파일을 올바른 크기로 확장해야 합니다.  또한 SQL Server에서 확장된 영역을 0으로 지정해야 합니다.  따라서 클라이언트는 부분 사양에 따라 확장된 영역에 데이터를 안전하게 배치할 수 있습니다.  부분 정보를 가져온 후에 파일이 확장된 경우, 차등 백업과 함께 백업된 로그를 재생하면 확장된 영역의 변경 내용이 복원됩니다.

**전체 기반을 만든 이후 데이터베이스 파일이 축소된 경우**

SQL Server는 메타데이터에 따라 파일을 필요한 크기로 자를 책임이 있습니다.  이 작업은 복원 전에 준비 단계로 수행됩니다.

**전체 기반을 만든 이후 데이터베이스 파일의 논리적 이름이 바뀐 경우**

논리적 이름은 기록기 메타데이터 문서 또는 백업 구성 요소 문서에 표시되지 않으므로 복원에 영향을 주지 않습니다.  클라이언트가 시스템 카탈로그 정보를 포함하는 주 데이터베이스 파일에 변경 내용을 적용하면 논리적 이름 변경이 복원됩니다.

**전체 기반을 만든 이후 데이터베이스 파일의 물리적 이름이 바뀐 경우**

차등 백업 시까지 이름 바꾸기가 적용되지 않은 경우 클라이언트가 여전히 데이터를 이전 위치로 복원합니다.  복원 후에 데이터베이스를 다시 시작하면 물리적 이름 바꾸기가 적용됩니다.  차등 백업 시까지 물리적 파일 이름 바꾸기가 이미 적용된 경우에는 부분 데이터(있는 경우)가 새 물리적 경로에서 백업되었습니다.  

### <a name="post-restore"></a>복원 후 작업

복원 후 이벤트 중에 SQL 기록기는 데이터베이스의 정상적인 다시 실행 작업 및 복구(SetAdditionalRestores()가 False로 설정된 경우)를 수행합니다.

## <a name="differential-backuprestore-for-full-text-catalogs"></a>전체 텍스트 카탈로그의 차등 백업/복원

SQL Server 전체 텍스트 카탈로그는 나머지 데이터베이스 파일과 함께 백업하거나 복원해야 하는 데이터베이스 리소스의 일부입니다.  전체 텍스트 카탈로그의 차등 백업은 타임스탬프를 기반으로 합니다.  SQL Server VSS 차등 백업/복원에는 단일 기준 백업이 있습니다.  즉, 컨테이너마다 기반이 달라지지 않습니다.  따라서 VSS 전체 텍스트 카탈로그 백업의 경우, 전체 텍스트 카탈로그 컨테이너마다 하나의 타임스탬프 기반이 있는 네이티브 SQL 차등 백업과 달리 모든 전체 텍스트 카탈로그 컨테이너에 대해 차등 백업이 단일 타임스탬프를 기반으로 합니다.

VSS에서 이 타임스탬프는 전체 백업 중에 설정되고 후속 차등 백업 중에 사용되는 구성 요소 차원의 속성으로 표현됩니다.  

### <a name="onidentify"></a>OnIdentify

OnIdentify에서 SQL 기록기는 IVssCreateWriterMetadata::SetBackupSchema()를 호출하여 VSS_BS_TIMESTAMPED 값을 설정합니다.  이 값은 SQL 기록기가 차등 기반 관리를 소유하고 있음을 백업 애플리케이션에 알립니다.

### <a name="setting-the-base-timestamp"></a>기준 타임스탬프 설정

기준 타임스탬프는 전체 백업 중에 설정됩니다.  **OnPostSnapshot()** 에서 기록기는 **IVssComponent::SetBackupStamp()** 를 호출하여 구성 요소와 타임스탬프를 백업 문서에 저장합니다.

### <a name="differential-backup"></a>차등 백업

백업 애플리케이션은 기준 전체 백업에서 이 타임스탬프를 검색하고, **IVssComponent::GetBackupStamp()** 호출을 통해 이전 기준 백업에서 기준 스탬프를 검색하여 기록기에 타임스탬프를 사용할 수 있도록 합니다.  그런 다음, **IVssBackupComponent::SetPreviousBackupStamp()** 를 호출하여 기록기에서 사용할 수 있도록 합니다.  기록기는 **IVssComponent::GetPreviousBackupStamp()** 를 호출하여 스탬프를 검색하고 **IVssComponent::AddDifferencedFilesByLastModifyTime()** 에 사용되는 타임스탬프로 변환합니다.  

**차등 백업 중 백업 애플리케이션의 책임** 차등 백업 중에 백업 애플리케이션은 다음 작업을 수행할 책임이 있습니다.

- 마지막으로 수정된 타임스탬프가 구성 요소에서 있는 파일 세트의 “마지막 수정 시간”에 지정된 타임스탬프보다 이후인 파일(전체 파일) 모두 백업
- 삭제된 파일 추적 및 검색  

**차등 복원 중 백업 애플리케이션의 책임** 차등 복원 중에 백업 애플리케이션은 다음 작업을 수행할 책임이 있습니다.

- 새 파일을 만들거나(아직 없는 경우) 기존 파일을 덮어써서(이미 있는 경우) 백업된 파일 모두 복원
- 복원된 파일이 기존 파일보다 큰 경우 콘텐츠를 배치하기 전에 파일 확장
- 복원된 파일이 기존 파일보다 작은 경우 복원된 파일의 크기와 같은 크기로 파일 자르기
- 삭제해야 하는 파일, 즉 차등 백업 시점에 없어야 하는 파일 모두 삭제

### <a name="copy-only-backup"></a>복사 전용 백업

특별한 목적으로 사용할 백업을 만들어야 하는 경우가 있습니다. 예를 들어 테스트 목적으로 데이터베이스 복사본을 만들어야 할 수 있습니다.  이 백업은 데이터베이스의 전체 백업 및 복원 절차에 영향을 주지 않아야 합니다. COPY_ONLY 옵션을 사용하면 백업이 “대역 외” 상태로 수행되고 정상적인 백업 시퀀스에 영향을 주지 않도록 지정됩니다. SQL 기록기는 SQL Server 인스턴스에서 “복사 전용” 백업 유형을 지원합니다.

백업 검색 단계에서 SQL 기록기는 **IVssCreateWriterMetadata::SetBackupSchema** 호출을 통해 지원되는 백업 스키마 옵션 VSS_BS_COPY를 설정하여 복사 전용 백업을 수행할 수 있습니다. 요청자는 **IVssBackupComponents::SetBackupState** 호출을 통해 VSS_BACKUP_TYPE 옵션을 VSS_BT_COPY로 설정하여 백업 유형을 복사 전용 백업으로 설정할 수 있습니다.

복사 전용 백업을 선택한 경우, 요청자가 각 파일의 백업 기록 상태와 관계없이 디스크에 있는 파일을 백업 미디어에 복사한다고 간주됩니다. SQL Server에서 백업 기록을 업데이트하지 않습니다. 이 유형의 백업은 추가 차등 백업 작업의 기준 백업으로 사용되지 않으며, 이전 차등 백업 기록을 수정하지도 않습니다.

### <a name="restore-with-move"></a>복원(이동)

VSS를 사용하면 백업 애플리케이션(요청자)이 **IVssComponent::SetNewTarget** 호출을 통해 새 복원 대상을 지정할 수 있습니다.  PreRestore() 및 PostRestore()에서 SQL 기록기는 지정된 새 대상이 하나 이상 있는지 확인합니다. 백업 애플리케이션은 실제 파일 복원/복사 시 파일을 새 위치에 물리적으로 복사할 책임이 있습니다.

백업 애플리케이션은 물리적 경로에 대해 새 대상을 지정할 수만 있고 파일 사양을 지정할 수는 없습니다.  예를 들어 c:\data\test.mdf에 있는 데이터베이스 파일의 경우 실제 파일 이름인 test.mdf는 변경할 수 없습니다.  c:\data 경로만 변경할 수 있습니다.  c:\ftdata\foo에 있는 전체 텍스트 카탈로그 컨테이너의 경우, VSS의 파일 사양은 “*”이고 VSS의 경로 사양은 c:\ftdata\foo이므로 전체 경로를 변경할 수 있습니다.  

### <a name="database-rename"></a>데이터베이스 이름 바꾸기

특히 SQL 데이터베이스를 원본 데이터베이스와 나란히 복원해야 하는 경우 요청자가 SQL 데이터베이스를 새 이름으로 복원해야 할 수 있습니다.  요청자는 복원 작업 중에 VSS 호출 **IVssBackupComponents::SetRestoreOptions()** (wszRestoreOptions 매개 변수)를 통해 사용자 지정 복원 옵션을 “새 구성 요소 이름” = <”새 이름”>으로 설정하여 이 옵션을 지정할 수 있습니다.

SQL 기록기는 새 구성 요소 이름 값의 전체 콘텐츠를 가져와 복원된 데이터베이스의 새 이름으로 사용합니다. 옵션을 지정하지 않으면 SQL은 데이터베이스를 원래 이름(구성 요소 이름)으로 복원합니다.

  > [!NOTE]
  > SQL 기록기는 현재, 데이터베이스를 새 인스턴스로 이동하기 위한 “인스턴스 간 이름 바꾸기”를 지원하지 않습니다.

### <a name="auto-recovered-snapshots"></a>자동 저장된 스냅샷

일반적으로 VSS 프레임워크를 사용하여 만든 SQL Server 데이터베이스 스냅샷은 복구되지 않은 상태입니다. 복구 단계를 수행하여 진행 중인 트랜잭션을 롤백하고 데이터베이스를 일관된 상태로 유지하기 전에는 스냅샷의 데이터에 안전하게 액세스할 수 없습니다. 스냅샷은 읽기 전용 상태이므로 정상적인 데이터베이스 연결 프로세스를 통해 복구할 수 없습니다.

스냅샷 생성 프로세스에서 스냅샷을 자동 저장할 수 있습니다. 기록기 메타데이터 문서의 일부로, SQL 기록기는 스냅샷의 데이터베이스에 대해 먼저 복구를 수행해야 스냅샷 세트를 지정할 때 데이터베이스에 액세스할 수 있음을 나타내기 위해 구성 요소 플래그 “VSS_CF_APP_ROLLBACK_RECOVERY”를 지정합니다. 요청자는 스냅샷이 앱 롤백 스냅샷(즉, 스냅샷에 있는 모든 데이터베이스 파일이 애플리케이션 사용을 위해 일관된 상태로 유지됨) 또는 백업 스냅샷(나중에 시스템 오류가 발생할 경우 복원할 데이터를 백업하는 데 사용되는 스냅샷)이어야 한다고 지정할 수 있습니다.

요청자는 이 구성 요소가 백업 이외의 목적으로 백업되고 있음을 나타내기 위해 VSS_VOLSNAP_ATTR_ROLLBACK_RECOVERY를 설정해야 합니다.  그러면 VSS는 SQL 기록기가 선택한 구성 요소에 지정한 VSS_CF_APP_ROLLBACK_RECOVERY와 VSS_VOLSNAP_ATTR_ROLLBACK_RECOVERY를 상호 연결하고 자동 복구가 수행되는지 판단합니다.  VSS는 스냅샷을 제한된 기간에 쓰기 가능으로 설정하고 스냅샷 컨텍스트에 VSS_VOLSNAP_ATTR_AUTORECOVERY 비트를 자동으로 추가합니다.

SQL Server의 경우 앱 롤백 스냅샷에만 자동 복구를 적용해야 하며, 백업 스냅샷에는 적용하면 안 됩니다. 앱 롤백 스냅샷의 경우 SQL 기록기가 PostSnapShot 이벤트 중에 자동 복구 프로세스를 시작합니다. 이 프로세스는 요청자가 스냅샷 세트에서 명시적으로 선택한 각 SQL Server 데이터베이스에 대해 다음을 수행합니다.

- 스냅샷 데이터베이스를 원래 SQL Server 인스턴스(즉, 원본 데이터베이스가 연결된 인스턴스)에 연결합니다.
- 데이터베이스를 복구합니다(“연결” 작업의 일부로 수행됨).
- 로그 파일을 축소합니다.

    이렇게 하면 VSS 공급자가 “소프트웨어 공급자”인 경우 VSS 프레임워크에서 수행해야 하는 불필요한 “쓰기 시 복사” 양이 줄어듭니다. 로그 파일 축소는 기본 동작입니다. 다음 레지스트리 키의 값을 1로 설정하면 이 동작을 사용하지 않도록 설정할 수 있습니다.
    
    HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\SQLWriter\
    Settings\DisableLogShrink
    
    이 기능은 스냅샷을 사용하여 로그에서 특정 시점의 특정 페이지 데이터를 내보내 온라인 데이터베이스의 문제를 해결할 수 있는 시나리오에서 유용할 수 있습니다.

- 데이터베이스를 분리합니다.

이제 쿼리를 위해 연결할 수 있는, 일관성 있고 복구된 스냅샷이 있습니다.

### <a name="multi-database-transactions"></a>다중 데이터베이스 트랜잭션

스냅샷 데이터베이스에 진행 중인 다중 데이터베이스 트랜잭션이 여러 개 포함되는 경우도 있습니다. 복구 작업 중에 SQL 기록기는 중단 가정 옵션을 사용하여 스냅샷의 데이터베이스를 연결합니다. 이렇게 하면 커밋 준비 상태인 트랜잭션을 포함하여 아직 커밋되지 않은 다중 데이터베이스 트랜잭션이 모두 롤백됩니다. 이로 인해 스냅샷 세트에 있는 데이터베이스 간에 일부 불일치가 발생할 수 있습니다. 예를 들어 A와 B라는 두 개의 데이터베이스가 있다고 가정합니다. 두 데이터베이스 간에 분산 트랜잭션이 있으며, 데이터베이스 A에서는 이 트랜잭션이 커밋된 상태이고 데이터베이스 B에서는 커밋 준비 상태입니다. 자동 복구 프로세스 중에 이 트랜잭션은 데이터베이스 A에서는 커밋되고 데이터베이스 B에서는 롤백됩니다. 이로 인해 스냅샷 세트에서 일부 불일치가 발생할 수 있습니다.

VSS 프레임워크가 Longhorn 시간 프레임에 릴리스할 예정인 MS DTC(Microsoft Distributed Transaction Coordinator) 구성 요소는 SQL Server 인스턴스 간의 데이터베이스에 걸쳐 있는 트랜잭션에 대해 이러한 불일치 문제를 해결합니다. 다음 버전의 SQL Server에서는 SQL Server 인스턴스 내의 데이터베이스에 걸쳐 있는 트랜잭션에 대해 이러한 불일치를 해결합니다.

### <a name="security-implications-for-autorecovered-snapshots"></a>자동 저장된 스냅샷의 보안에 미치는 영향

VSS 스냅샷의 경우, 자동 복구 후에 SQL Server 계정이 속한 특수 기본 제공 그룹만 액세스할 수 있도록 ACL(액세스 제어 목록)을 사용하여 파일이 보호됩니다.  이렇게 하면 Box 관리자 또는 해당 특수 그룹의 구성원이 데이터베이스를 연결할 수 있습니다. 스냅샷의 데이터베이스 파일 연결을 요청하는 클라이언트는 SQL Server 계정 또는 Builtin/Administrators 구성원이어야 합니다.

### <a name="special-cases"></a>특수 사례

이 섹션에서는 SQL 기록기 기반 백업 및 복원 작업 중에 발생하는 몇 가지 특수 사례에 대해 설명합니다.

#### <a name="autoclose-databases"></a>데이터베이스 자동 닫기

비구성 요소 기반 백업의 경우 조각난 조건을 확인할 때 데이터베이스를 자동으로 닫지만, 자동으로 닫히는 데이터베이스는 백업 작업 중에 명시적으로 동결되지 않습니다.

여기에 예상되는 시나리오는 닫힌 데이터베이스가 여러 개 있을 수 있고, 스냅샷 비용을 최소화하려는 경우입니다.  자동으로 닫히는 데이터베이스는 일반적으로 리소스가 부족한 저사양 구성에서 사용됩니다.

#### <a name="file-list"></a>파일 목록

각 데이터베이스의 파일 목록은 백업 준비 이벤트 이전의 열거 단계에서 확인됩니다.  열거와 동결 사이에 데이터베이스 파일 목록이 변경된 경우, 애플리케이션이 파일 목록을 다시 검사하지 않으면 데이터베이스가 조각날 수 있습니다. 이로 인해 문제가 발생하는 것은 아니지만 공급업체에서 유의해야 하는 사항입니다.

#### <a name="stopped-instances"></a>중지된 인스턴스

열거 단계에서 SQL Server 인스턴스가 실행되고 있지 않으면 해당 인스턴스의 데이터베이스를 선택할 수 없습니다.

열거와 백업 준비 이벤트 사이의 간격에 인스턴스가 중지될 경우 중지된 인스턴스의 데이터베이스가 모두 무시됩니다.

#### <a name="system-and-user-databases"></a>시스템 및 사용자 데이터베이스

SQL Server의 시스템 데이터베이스로는 SQL Server와 함께 제공 및 설치되는 master, model, msdb 데이터베이스 등이 있습니다. 이 섹션에서는 VSS 스냅샷 백업 프로세스에서 이러한 데이터베이스를 처리하는 방법을 설명합니다.

### <a name="system-databases"></a>시스템 데이터베이스

master 데이터베이스를 복원하려면 인스턴스를 중지하고 백업 애플리케이션을 통해 데이터베이스 파일을 바꾼 다음, 인스턴스를 다시 시작해야 합니다. 롤포워드는 지원되지 않습니다.

SQL 기록기는 인스턴스를 종료하지 않고 model 및 msdb 데이터베이스를 온라인에서 복원할 수 있도록 지원합니다.


#### <a name="simple-recovery-model-user-databases"></a>단순 복구 모델 사용자 데이터베이스

단순 복구 모델을 사용하는 사용자 데이터베이스와 함께 master 데이터베이스를 복원하는 경우, master 데이터베이스와 동일한 방법으로 사용자 데이터베이스를 복원할 수 있습니다. 인스턴스를 종료하고 볼륨을 복사하거나 탑재하기만 하면 됩니다.  SQL 인스턴스를 시작하면 모든 항목이 복구됩니다.

#### <a name="rolling-forward-user-databases"></a>사용자 데이터베이스 롤포워드

master 데이터베이스 복구와 함께 사용자 데이터베이스를 복구 및 롤포워드해야 하는 경우, 인스턴스에서 master 데이터베이스와 사용자 데이터베이스를 함께 시작하고 복구하면 안 됩니다.

절차는 다음과 같습니다.

1. SQL Server 인스턴스가 중지되었는지 확인합니다.
1. 두 단계로 복원을 수행합니다.
    1. VSS를 사용한 파일 복사/볼륨 탑재를 통해 동시에 복구해야 하는 사용자 데이터베이스(즉, 단순 복구 모드 사용자 데이터베이스) 및 시스템 데이터베이스를 복원합니다.
        1. 롤포워드할 사용자 데이터베이스가 시스템 데이터베이스와 다른 볼륨에 있는 경우 지금은 해당 볼륨을 다시 가져오면 안 됩니다. 이 시나리오에서는 백업 전에 계획이 필요합니다.
        1. 사용자 데이터베이스가 시스템 데이터베이스와 다른 볼륨에 있는 경우 SQL Server에서 사용자 데이터베이스를 숨겨야 합니다.
    1. -f 매개 변수를 사용하여 SQL Server 인스턴스를 시작합니다.  -f 시작 옵션을 사용하는 경우 master 데이터베이스만 복원할 수 있습니다.
        1. 롤포워드할 각 데이터베이스에 대해 ALTER DATABASE \<x> SET OFFLINE을 실행합니다.  또는 데이터베이스를 분리합니다.
        1. SQL Server 인스턴스를 중지합니다.
        1. SQL Server 인스턴스를 시작합니다. 롤포워드할 사용자 데이터베이스의 파일이 SQL Server에 표시되지 않습니다.

“전체 복원(롤포워드 포함)”에 설명된 대로 VSS를 통해 NORECOVERY를 사용하여 사용자 데이터베이스를 복원합니다.

## <a name="appendix"></a>부록

### <a name="writer-metadata-document--an-example"></a>기록기 메타데이터 문서:  예제

DB1이라는 예제 데이터베이스가 있다고 가정합니다. 이 데이터베이스는 Server1 머신의 SQL Server 인스턴스 Instance1에 속해 있으며, 다음 데이터베이스/로그 파일을 포함합니다.

- c:\db\DB1.mdf에 저장된 “primary”라는 데이터베이스 파일
- c:\db\DB1.ndf에 저장된 “secondary”라는 데이터베이스 파일
- c:\db\DB1.ldf에 저장된 “log”라는 데이터베이스 로그 파일
- c:\db\ftdata\foo 디렉터리 아래에 저장된 “foo”라는 전체 텍스트 카탈로그
- c:\db\ftdata\bar 디렉터리 아래에 저장된 “bar”라는 전체 텍스트 카탈로그

데이터베이스의 기록기 메타데이터는 다음과 같습니다.

**데이터베이스 수준 파일 그룹 구성 요소**

- ComponentType: VSS_CT_FILEGROUP
- LogicalPath: “Server1\Instance1”
- ComponentName: “DB1”
- Caption: NULL
- pbIcon: NULL
- cbIcon: 0
- bRestoreMetadata: FALSE
- NotifyOnBackupComplete: TRUE
- Selectable: TRUE
- SelectableForRestore: TRUE
- ComponentFlags: VSS_CF_APP_ROLLBACK_RECOVERY

**파일 그룹 파일**

- LogicalPath: “Server1\Instance1”
- GroupName: “DB1”
- Path: “c:\db”
- FileSpec: “DB1.mdf”
- Recursive: FALSE
- AlternatePath: NULL
- BackupTypeMask: VSS_FSBT_ALL_BACKUP_REQUIRED | VSS_FSBT_ALL_SNAPSHOT_REQUIRED
- 파일 그룹 파일
- LogicalPath: “Server1\Instance1”
- GroupName: “DB1”
- Path: “c:\db”
- FileSpec: “DB1.ndf”
- Recursive: FALSE
- AlternatePath: NULL
- BackupTypeMask: VSS_FSBT_ALL_BACKUP_REQUIRED | VSS_FSBT_ALL_SNAPSHOT_REQUIRED

**파일 그룹 파일**

- LogicalPath: “Server1\Instance1”
- GroupName: “DB1”
- Path: “c:\db”
- FileSpec: “DB1.ldf”
- Recursive: FALSE
- AlternatePath: NULL
- BackupTypeMask: VSS_FSBT_ALL_BACKUP_REQUIRED | VSS_FSBT_ALL_SNAPSHOT_REQUIRED

**파일 그룹 파일:**

- LogicalPath: “Server1\Instance1”
- GroupName: “DB1”
- Path: “c:\db\ftdata\foo”
- FileSpec: “*”
- Recursive: TRUE
- AlternatePath: NULL
- BackupTypeMask: VSS_FSBT_ALL_BACKUP_REQUIRED | VSS_FSBT_ALL_SNAPSHOT_REQUIRED

**파일 그룹 파일:**

- LogicalPath: “Server1\Instance1”
- GroupName: “DB1”
- Path: “c:\db\ftdata\bar”
- FileSpec: “*”
- Recursive: TRUE
- AlternatePath: NULL
- BackupTypeMask: VSS_FSBT_ALL_BACKUP_REQUIRED | VSS_FSBT_ALL_SNAPSHOT_REQUIRED

서버 인스턴스가 머신의 기본 인스턴스인 경우 논리적 경로는 “Server1”이 됩니다.


    
## <a name="see-also"></a>참고 항목  
 [BACKUP&#40;Transact-SQL&#41;](../../t-sql/statements/backup-transact-sql.md)   
 [RESTORE&#40;Transact-SQL&#41;](../../t-sql/statements/restore-statements-transact-sql.md)   
 [SQL Server 데이터베이스 백업 및 복원](../../relational-databases/backup-restore/back-up-and-restore-of-sql-server-databases.md)   
 [복사 전용 백업&#40;SQL Server&#41;](../../relational-databases/backup-restore/copy-only-backups-sql-server.md)   
 [트랜잭션 로그 백업&#40;SQL Server&#41;](../../relational-databases/backup-restore/transaction-log-backups-sql-server.md)   
 [트랜잭션 로그 백업 적용&#40;SQL Server&#41;](../../relational-databases/backup-restore/apply-transaction-log-backups-sql-server.md)    
 [SQL Server 트랜잭션 로그 아키텍처 및 관리 가이드](../../relational-databases/sql-server-transaction-log-architecture-and-management-guide.md)
  
